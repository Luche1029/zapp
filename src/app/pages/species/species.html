<div class="page-wrapper">

  <!-- Lista specie -->
  <div class="module-container" [class.hidden]="isMobile && selectedSpecies">
   
    <h2>Specie</h2>
    <button class="add-button" (click)="openAddSpeciesForm()">
      <span class="material-icons">add</span>
    </button>

    <div *ngIf="loading">Caricamento in corso...</div>
    <div *ngIf="error" class="error">{{ error }}</div>

    <ul *ngIf="!loading && !error">
      <li *ngFor="let sp of species; let i = index"
          [class.active]="i === selectedIndex"
          (click)="selectSpecies(i)">
        <strong>{{ sp.common_name }}</strong>
        <span>({{ sp.scientific_name }})</span>
      </li>
    </ul>
  </div>

  <div class="module-container" *ngIf="selectedSpecies">

      <header>
        <h2>    
        <button (click)="toggleEdit()">
          <span class="material-icons">{{ editMode ? 'undo' : 'edit' }}</span>
        </button>  
        {{ selectedSpecies.common_name }} 
        <small *ngIf="selectedSpecies.scientific_name">({{ selectedSpecies.scientific_name }})</small></h2>
        <div class="image-container">
          <button class="left"  (click)="openCamera()">
            <span class="material-icons" >photo_camera</span>
          </button>
          <button class="right">
            <span class="material-icons" (click)="uploadImage()">upload</span>
          </button>
          <input 
            type="file" 
            accept="image/*"
            capture="environment"
            #fileInput
            style="display: none"
            (change)="onFileSelected($event)" />
          <div *ngIf="uploading">Caricamento...</div>
          
          
          <img 
            *ngIf="SUPABASE_URL + selectedSpecies.image_url" 
            [src]="SUPABASE_URL + selectedSpecies.image_url" 
            alt="{{ selectedSpecies.common_name }}" />
        </div>
      </header>
      <form [formGroup]="speciesForm" >
        <ul>
          <li *ngIf="selectedSpecies.common_name || editMode">
              <strong>Nome comune:</strong>
              <input 
                type="text" 
                [value]="selectedSpecies.common_name" 
                formControlName="common_name"
                [class]="editMode ? 'editable' : ''"/>
          </li>
          <li *ngIf="selectedSpecies.scientific_name || editMode">
              <strong>Nome scientifico:</strong>
              <input 
                type="text" 
                [value]="selectedSpecies.scientific_name" 
                formControlName="scientific_name"
                [class]="editMode ? 'editable' : ''"/>
          </li>
          <li *ngIf="selectedSpecies.category_id || editMode">
            <strong>Categoria:</strong>
            <select formControlName="category_id">
              <option *ngFor="let cat of categories" [value]="cat.id">{{cat.name}}</option>
            </select> 
          </li>
          <li *ngIf="selectedSpecies.sunExposure || editMode">
            <strong>Esposizione:</strong>    
            <select formControlName="sun_exposure_id">
              <option *ngFor="let se of sunExposure" [value]="se.id">{{se.name}}</option>
            </select> 
          <li *ngIf="selectedSpecies.watering_freq || editMode">
            <strong>Annaffiatura:</strong>
            <input 
                type="number" 
                [value]="selectedSpecies.watering_freq" 
                formControlName="watering_freq"
                [class]="editMode ? 'editable' : ''"/>
          </li>
          <li *ngIf="selectedSpecies.fertilizing_freq || editMode">
            <strong>Concimazione:</strong>
            <input 
                type="number" 
                [value]="selectedSpecies.fertilizing_freq" 
                formControlName="fertilizing_freq"
                [class]="editMode ? 'editable' : ''"/>
          <li *ngIf="selectedSpecies.pruning_freq || editMode ">
            <strong>Potatura:</strong>
             <input 
                type="number" 
                [value]="selectedSpecies.pruning_freq" 
                formControlName="pruning_freq"
                [class]="editMode ? 'editable' : ''"/>
          </li>
          <li *ngIf="selectedSpecies.sowing_period || editMode">
            <strong>Periodo semina:</strong>
            <input 
                type="text" 
                [value]="selectedSpecies.sowing_period" 
                formControlName="sowing_period"
                [class]="editMode ? 'editable' : ''"/> 
          </li>
          <li *ngIf="selectedSpecies.harvest_period || editMode">
            <strong>Periodo raccolta:</strong>
            <input 
                type="text" 
                [value]="selectedSpecies.harvest_period" 
                formControlName="harvest_period"
                [class]="editMode ? 'editable' : ''"/> 
          </li>
          <li *ngIf="selectedSpecies.notes || editMode">
            <strong>Note:</strong> 
            <textarea 
              formControlName="notes"
              [class]="editMode ? 'editable' : ''"
              >{{ selectedSpecies.notes }}</textarea>
          </li>        
          <li *ngIf="editMode">
            <button (click)="saveSpecies()">
              <span  class="material-icons">save</span>
            </button>
          </li>
        </ul>

      </form>
   

    <button class="back-button" (click)="deselectSpecies()" *ngIf="isMobile">
      <span class="material-icons">arrow_left</span>
    </button>  
  </div>

  <!-- FAB per tornare a plants -->
  <button class="fab" (click)="goToPlants()">
    <span class="material-icons">arrow_back</span>
  </button>

  <div class="camera-modal" *ngIf="cameraOpen">
    <div class="camera-content">
      <button type="button" (click)="closeCamera()" class="button-close">
        <span class="material-icons">close</span>
      </button>
      <video #video autoplay playsinline></video>

      <div class="cam-buttons">
        <button type="button" (click)="takePhoto()" class="">
          <span class="material-icons">camera</span>
        </button>

      </div>

      <!-- opzionale: preview scatto -->
      <img *ngIf="shotUrl" [src]="shotUrl" alt="Scatto" style="max-width: 200px;" />

      <!-- nascosto: ci serve per catturare il frame -->
      <canvas #canvas style="display:none"></canvas>
    </div>
  </div>

  <!-- Modal aggiunta specie -->
<div class="modal" *ngIf="showAddModal">
  <div class="modal-content">
    <h3>Aggiungi specie</h3>
    <form (ngSubmit)="addSpecies()" #speciesForm="ngForm">

      <!-- Nome comune -->
      <label>Nome comune</label>
      <input type="text" [(ngModel)]="newSpecies.common_name" name="common_name" required />

      <!-- Nome scientifico -->
      <label>Nome scientifico</label>
      <input type="text" [(ngModel)]="newSpecies.scientific_name" name="scientific_name" />

      <!-- Categoria -->
      <label>Categoria</label>
      <select [(ngModel)]="newSpecies.category" name="category">
        <option *ngFor="let c of categories" [value]="c.id">{{c.name}}</option>
      </select>

      <!-- Esposizione -->
      <label>Esposizione</label>
      <select [(ngModel)]="newSpecies.sun_exposure" name="sun_exposure">
        <option *ngFor="let e of sunExposure" [value]="e.id">{{e.name}}</option>
      </select>

      <!-- Frequenza annaffiatura -->
      <label>Frequenza annaffiatura (giorni)</label>
      <input type="number" [(ngModel)]="newSpecies.watering_freq" name="watering_freq" min="1" />

      <!-- Frequenza concimazione -->
      <label>Frequenza concimazione (giorni)</label>
      <input type="number" [(ngModel)]="newSpecies.fertilizing_freq" name="fertilizing_freq" min="1" />

      <!-- Frequenza potatura -->
      <label>Frequenza potatura (giorni)</label>
      <input type="number" [(ngModel)]="newSpecies.pruning_freq" name="pruning_freq" min="1" />

      <!-- Periodo semina -->
      <label>Periodo semina</label>
      <input type="text" [(ngModel)]="newSpecies.sowing_period" name="sowing_period" />

      <!-- Periodo raccolta -->
      <label>Periodo raccolta</label>
      <input type="text" [(ngModel)]="newSpecies.harvest_period" name="harvest_period" />

      <!-- Note -->
      <label>Note</label>
      <textarea [(ngModel)]="newSpecies.notes" name="notes"></textarea>

      <!-- URL immagine -->
      <label>URL immagine</label>
      <input type="url" [(ngModel)]="newSpecies.image_url" name="image_url" />

      <!-- Pulsanti -->
      <button type="submit" [disabled]="!speciesForm.valid">Salva</button>
      <button type="button" (click)="closeAddSpeciesForm()">Annulla</button>
    </form>
  </div>
</div>


</div>
